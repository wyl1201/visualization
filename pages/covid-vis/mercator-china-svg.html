<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å£°æ˜å¼å›¾å½¢ç³»ç»Ÿ-SVG</title>
    <style>
      .map-legend {
        position: absolute;
        left: 50px;
        bottom: 200px;
        width: 16px;
      }
      .item {
        height: 32px;
        position: relative;
      }

      item:first-child {
        border-radius: 1px 1px 0 0;
      }
      .item > p {
        position: absolute;
        line-height: 32px;
        height: 32px;
        white-space: nowrap;
        font-size: 16px;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #737373;
        font-weight: 400;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- Map Legend -->
      <div class="map-legend">
        <div class="item" style="background-color: rgb(255, 112, 79)">
          <p>1000äººä»¥ä¸Š</p>
        </div>
        <div class="item" style="background-color: rgb(255, 170, 128)">
          <p>200-999äºº</p>
        </div>
        <div class="item" style="background-color: rgb(255, 208, 166)">
          <p>50-199äºº</p>
        </div>
        <div class="item" style="background-color: rgb(255, 231, 184)">
          <p>1-49äºº</p>
        </div>
        <div class="item" style="background-color: rgb(226, 235, 244)">
          <p>0äºº</p>
        </div>
      </div>
    </div>
    <script type="module">
      import '/style.css'
      import './main.css'

      const width = 800
      const height = 800

      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg')
      svg.setAttribute('width', `${width}px`)
      svg.setAttribute('height', `${height}px`)
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`)

      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g')

      // ä¸­å›½ç»åº¦èŒƒå›´ï¼š73Â°33â€²Eè‡³135Â°05â€²Eï¼›çº¬åº¦èŒƒå›´ï¼š3Â°51â€²Nè‡³53Â°33â€²Nã€‚
      // å½“ä¸­çš„å­—æ¯ä¸“E ï¼Œ è¡¨ç¤ºä¸œç»ï¼›å±å­—æ¯Nï¼Œè¡¨ç¤ºåŒ—çº¬ã€‚ä¸œç»æ­£æ•°ï¼Œè¥¿ç»ä¸ºè´Ÿæ•°ï¼›
      // åŒ—çº¬ä¸ºæ­£æ•°ï¼Œå—çº¬ä¸ºè´Ÿæ•°ã€‚
      // [73.502355, 3.39716187, 135.09567, 53.563269]

      function projection([longitude, latitude]) {
        const x = (width * (longitude - 73.33)) / (135.09567 - 73.502355)
        const y =
          height * (1 - (latitude - 3.39716187) / (53.563269 - 3.39716187))
        return [x, y]
      }

      // æ•´åˆåœ°ç†æ•°æ®å’Œç–«æƒ…æ•°æ®
      function mapDataToCountries(geoData, convidData) {
        const convidDataMap = {}
        const provinces = convidData.diseaseh5Shelf.areaTree[0].children
        provinces.forEach((d) => {
          const name = d.name
          const adcode =
            name === 'é¦™æ¸¯'
              ? 810000
              : name === 'æ¾³é—¨'
              ? 820000
              : name === 'å°æ¹¾'
              ? 710000
              : d.adcode
          convidDataMap[adcode] = d
        })
        console.log(
          `ğŸš€ ~ file: mercator-china-svg.html ~ line 99 ~ provinces.forEach ~ convidDataMap`,
          convidDataMap
        )

        geoData.features.forEach((d) => {
          const adcode = d.properties.adcode
          // ä¹æ®µçº¿å¤„ç†
          d.properties.convid = convidDataMap[adcode] || {}
        })
      }

      // æˆ‘æŠŠæ— äººæ„ŸæŸ“åˆ°æ„ŸæŸ“äººæ•°è¶…è¿‡ 1000 äººåˆ’åˆ†äº† 5 ä¸ªç­‰çº§ï¼Œ
      // æ¯ä¸ªç­‰çº§ç”¨ä¸åŒçš„é¢œè‰²è¡¨ç¤ºï¼š
      // è‹¥è¯¥åœ°åŒºæ— äººæ„ŸæŸ“ï¼Œæ¸²æŸ“æˆ rgb(226, 235, 244) è‰²
      // è‹¥è¯¥åœ°åŒºæ„ŸæŸ“äººæ•°å°äº 50ï¼Œæ¸²æŸ“æˆ rgb(255, 231, 184) è‰²
      // è‹¥è¯¥åœ°åŒºæ„ŸæŸ“äººæ•° 200 äººï¼Œæ¸²æŸ“æˆ rgb(255, 208, 166) è‰²
      // è‹¥è¯¥åœ°åŒºæ„ŸæŸ“äººæ•° 1000 äººï¼Œæ¸²æŸ“æˆ rgb(255, 170, 128) è‰²
      // è‹¥è¯¥åœ°åŒºæ„ŸæŸ“äººæ•° å¤§äºç­‰äº1000äººï¼Œæ¸²æŸ“æˆ rgb(255, 112, 79) è‰²

      function mapColor(nowConfirm) {
        if (!nowConfirm) {
          return 'rgb(226, 235, 244)'
        }
        if (nowConfirm < 50) {
          return 'rgb(255, 231, 184)'
        }
        if (nowConfirm < 200) {
          return 'rgb(255, 208, 166)'
        }
        if (nowConfirm < 1000) {
          return 'rgb(255, 170, 128)'
        }
        return 'rgb(255, 112, 79)'
      }

      function drawPoints(g, points, fillStyle = 'none') {
        const path = document.createElementNS(
          'http://www.w3.org/2000/svg',
          'path'
        )
        // è·¯å¾„
        path.setAttribute('stroke', 'black')
        path.setAttribute('stroke-width', '0.5')
        path.setAttribute('stroke-linejoin', 'round')
        path.setAttribute('stroke-opacity', '1')
        path.setAttribute('line-cap', 'round')
        path.setAttribute('fill', fillStyle)
        path.setAttribute(
          'd',
          points.reduce((path, [x, y], currentIndex) => {
            if (currentIndex == 0) {
              return `M${x} ${y}`
            }
            return `${path}L${x} ${y}`
          }, '')
        )
        g.appendChild(path)
      }

      function drawText(g, point, name, nowConfirm) {
        const [x, y] = projection(point)
        const text = document.createElementNS(
          'http://www.w3.org/2000/svg',
          'text'
        )
        text.setAttribute('fill', 'black')
        text.setAttribute('font-family', 'Arial')
        text.setAttribute('font-size', '12px')
        text.setAttribute('text-anchor', 'middle')
        text.setAttribute('x', x)
        text.setAttribute('y', y)
        // const name = node.data.name
        text.textContent = `${name}: ${nowConfirm}äºº`
        g.appendChild(text)
      }

      ;(async function () {
        // ä¸­å›½åœ°å›¾çš„åœ°ç†æ•°æ®
        const chinaData = await (
          await fetch('./asset/china-geojson.json')
        ).json()

        // ç–«æƒ…æ•°æ®
        const { data: covidData } = await (
          await fetch(
            'https://api.inews.qq.com/newsqa/v1/query/inner/publish/modules/list?modules=localCityNCOVDataList,diseaseh5Shelf'
          )
        ).json()

        mapDataToCountries(chinaData, covidData)

        const features = chinaData.features
        features.forEach(({ geometry, properties }) => {
          const { name, centroid, center, convid } = properties

          // return
          // ç¡®è¯Šäººæ•°
          const nowConfirm = convid.total ? convid.total.nowConfirm : undefined
          // è®¾ç½®å¡«å……é¢œè‰²
          const fillStyle =
            nowConfirm != undefined ? mapColor(nowConfirm) : undefined

          if (geometry.type === 'MultiPolygon') {
            const coordinates = geometry.coordinates
            if (coordinates) {
              coordinates.forEach((contours) => {
                contours.forEach((path) => {
                  const points = path.map(projection)
                  drawPoints(g, points, fillStyle)
                })
              })
            }
          } else if (geometry.type == 'Polygon') {
            const contours = geometry.coordinates
            contours.forEach((path) => {
              const points = path.map(projection)
              drawPoints(g, points, fillStyle)
            })
          }
        })

        // æ˜¾ç¤ºä¿¡æ¯
        features.forEach(({ properties }) => {
          const { name, centroid, center, convid } = properties
          if (!convid || !convid.total) {
            return
          }
          // ç¡®è¯Šäººæ•°
          const nowConfirm = convid.total.nowConfirm

          const [x, y] = projection(centroid || center)
          try {
            if (centroid || center) {
              const [x, y] = projection(centroid || center)
              drawText(g, centroid, name, nowConfirm)
            }
          } catch (error) {}
        })

        svg.appendChild(g)
        const app = document.querySelector('#app')
        app.appendChild(svg)
      })()
    </script>
  </body>
</html>
